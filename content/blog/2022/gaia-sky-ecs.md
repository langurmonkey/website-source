+++
author = "Toni Sagrista Selles"
categories = []
tags = []
date = 2022-10-19
linktitle = ""
title = "Huge refactoring in Gaia Sky: ECS"
description = "Moving the old inheritance hierarchy to an entity component system"
featuredpath = "date"
type = "post"
+++

In these last few days I have merged a [huge internal refactoring](https://codeberg.org/gaiasky/gaiasky/pulls/655) into Gaia Sky's master
branch. This refactoring has been cooking for several months and has adapted or completely
replaced virtually every piece in the code base. Read on if you want to know more.

<!--more-->

Entity component systems
------------------------

Up until very recently, the internal model in Gaia Sky was implemented with an OOP inheritance hierarchy with
a baked in scene graph and octree. The model was huge, with an object called `SceneGraphNode` at the root and a 
deep structure that went down several levels and some 50 different object types. Maintenance was difficult,
and the addition of new types was even more challenging. 
It was clear that a new model was required, and I immediately looked at [entity component systems (ECS)](https://en.wikipedia.org/wiki/Entity_component_system).
ECS is essentially an architectural pattern often used in video games. The model is based on entity objects, which are
only bags of components, which hold the data, and are processed by the systems, which contain the logic. An entity is 
ideally defined by its components only. Systems operate on entities depending on the actual components that they
hold. This paradigm is very convenient, as it replaces inheritance with composition. You can create entirely
new objects by just grouping a bunch of components together.


Actual implementation
---------------------

The work was split into phases:

1. The first phase moved the JSON loading and recreates the whole structure into entities and components.
2. The second phase moved the logic in the scene graph objects into systems and achieved a fully working build.
3. The third phase also incorporated the current renderer into the ECS structure.
4. Once everything was in place and working, we removed the old model.

Once this was implemented, the code base became wildly different and much more maintainable. It enables easier parallelization in two different ways:

First, some of the update systems can run in parallel. When the first top-down update of the scene graph has been completed, the rest of the update operations can essentially be run in parallel. This wasn't possible with the old model, as the update operation was monolithic and sequential for all objects.
Second, it will possibly enable concurrent update/render processes (i.e. run the update thread separate from the main render thread). Before, the update/render cycle ran in the same thread:

<!-- SEQUENTIAL UPDATE -->
<div style="display:block; margin:auto; text-align: center">
<svg aria-labelledby="chart-title-mermaid chart-desc-mermaid" role="img" viewBox="0.000003814697265625 0 88.8125 534.7826538085938" style="max-width: 155.421875px;" height="534.7826538085938" class="statediagram" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid"><title id="chart-title-mermaid"></title><desc id="chart-desc-mermaid"></desc><style>#mermaid {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}#mermaid .error-icon{fill:#a44141;}#mermaid .error-text{fill:#ddd;stroke:#ddd;}#mermaid .edge-thickness-normal{stroke-width:2px;}#mermaid .edge-thickness-thick{stroke-width:3.5px;}#mermaid .edge-pattern-solid{stroke-dasharray:0;}#mermaid .edge-pattern-dashed{stroke-dasharray:3;}#mermaid .edge-pattern-dotted{stroke-dasharray:2;}#mermaid .marker{fill:lightgrey;stroke:lightgrey;}#mermaid .marker.cross{stroke:lightgrey;}#mermaid svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid defs #statediagram-barbEnd{fill:lightgrey;stroke:lightgrey;}#mermaid g.stateGroup text{fill:#81B1DB;stroke:none;font-size:10px;}#mermaid g.stateGroup text{fill:#ccc;stroke:none;font-size:10px;}#mermaid g.stateGroup .state-title{font-weight:bolder;fill:#e0dfdf;}#mermaid g.stateGroup rect{fill:#1f2020;stroke:#81B1DB;}#mermaid g.stateGroup line{stroke:lightgrey;stroke-width:1;}#mermaid .transition{stroke:lightgrey;stroke-width:1;fill:none;}#mermaid .stateGroup .composit{fill:#333;border-bottom:1px;}#mermaid .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px;}#mermaid .state-note{stroke:hsl(180, 0%, 18.3529411765%);fill:hsl(180, 1.5873015873%, 28.3529411765%);}#mermaid .state-note text{fill:rgb(183.8476190475, 181.5523809523, 181.5523809523);stroke:none;font-size:10px;}#mermaid .stateLabel .box{stroke:none;stroke-width:0;fill:#1f2020;opacity:0.5;}#mermaid .edgeLabel .label rect{fill:#1f2020;opacity:0.5;}#mermaid .edgeLabel .label text{fill:#ccc;}#mermaid .label div .edgeLabel{color:#ccc;}#mermaid .stateLabel text{fill:#e0dfdf;font-size:10px;font-weight:bold;}#mermaid .node circle.state-start{fill:#f4f4f4;stroke:#f4f4f4;}#mermaid .node .fork-join{fill:#f4f4f4;stroke:#f4f4f4;}#mermaid .node circle.state-end{fill:#cccccc;stroke:#333;stroke-width:1.5;}#mermaid .end-state-inner{fill:#333;stroke-width:1.5;}#mermaid .node rect{fill:#1f2020;stroke:#81B1DB;stroke-width:1px;}#mermaid .node polygon{fill:#1f2020;stroke:#81B1DB;stroke-width:1px;}#mermaid #statediagram-barbEnd{fill:lightgrey;}#mermaid .statediagram-cluster rect{fill:#1f2020;stroke:#81B1DB;stroke-width:1px;}#mermaid .cluster-label,#mermaid .nodeLabel{color:#e0dfdf;}#mermaid .statediagram-cluster rect.outer{rx:5px;ry:5px;}#mermaid .statediagram-state .divider{stroke:#81B1DB;}#mermaid .statediagram-state .title-state{rx:5px;ry:5px;}#mermaid .statediagram-cluster.statediagram-cluster .inner{fill:#333;}#mermaid .statediagram-cluster.statediagram-cluster-alt .inner{fill:#555;}#mermaid .statediagram-cluster .inner{rx:0;ry:0;}#mermaid .statediagram-state rect.basic{rx:5px;ry:5px;}#mermaid .statediagram-state rect.divider{stroke-dasharray:10,10;fill:#555;}#mermaid .note-edge{stroke-dasharray:5;}#mermaid .statediagram-note rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:hsl(180, 0%, 18.3529411765%);stroke-width:1px;rx:0;ry:0;}#mermaid .statediagram-note rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:hsl(180, 0%, 18.3529411765%);stroke-width:1px;rx:0;ry:0;}#mermaid .statediagram-note text{fill:rgb(183.8476190475, 181.5523809523, 181.5523809523);}#mermaid .statediagram-note .nodeLabel{color:rgb(183.8476190475, 181.5523809523, 181.5523809523);}#mermaid .statediagram .edgeLabel{color:red;}#mermaid #dependencyStart,#mermaid #dependencyEnd{fill:lightgrey;stroke:lightgrey;stroke-width:1;}#mermaid :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><defs><marker orient="auto" markerUnits="strokeWidth" markerHeight="14" markerWidth="20" refY="7" refX="19" id="statediagram-barbEnd"><path d="M 19,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge0" d="M44.40625,22.000000476837158L44.40625,26.166667222976685C44.40625,30.33333396911621,44.40625,38.666667461395264,44.40625,47.000000874201454C44.40625,55.33333428700765,44.40625,63.66666762034098,44.40625,67.83333428700765L44.40625,72.00000095367432"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge1" d="M44.40625,106.13043689727783L44.40625,110.2971035639445C44.40625,114.46377023061116,44.40625,122.7971035639445,44.40625,131.13043689727783C44.40625,139.46377023061117,44.40625,147.7971035639445,44.40625,151.96377023061117L44.40625,156.13043689727783"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge2" d="M44.40625,190.26087284088135L44.40625,194.427539507548C44.40625,198.5942061742147,44.40625,206.927539507548,44.40625,215.26087284088135C44.40625,223.5942061742147,44.40625,231.927539507548,44.40625,236.0942061742147L44.40625,240.26087284088135"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge3" d="M44.40625,274.39130878448486L44.40625,278.55797545115155C44.40625,282.7246421178182,44.40625,291.05797545115155,44.40625,299.39130878448486C44.40625,307.7246421178182,44.40625,316.05797545115155,44.40625,320.2246421178182L44.40625,324.39130878448486"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge4" d="M44.40625,358.5217447280884L44.40625,362.68841139475506C44.40625,366.8550780614217,44.40625,375.18841139475506,44.40625,383.5217447280884C44.40625,391.8550780614217,44.40625,400.18841139475506,44.40625,404.3550780614217L44.40625,408.5217447280884"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge5" d="M44.40625,442.6521806716919L44.40625,446.8188473383586C44.40625,450.9855140050252,44.40625,459.3188473383586,44.40625,467.6521806716919C44.40625,475.9855140050252,44.40625,484.3188473383586,44.40625,488.4855140050252L44.40625,492.6521806716919"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(44.40625, 15.000000476837158)" id="state-root_start-0" class="node default"><circle height="14" width="14" r="7" class="state-start"></circle></g><g transform="translate(44.40625, 89.06521892547607)" id="state-update1-1" class="node statediagram-state"><rect height="34.130435943603516" width="72.81250381469727" y="-17.065217971801758" x="-36.40625190734863" style="" class="basic label-container"></rect><g transform="translate(-28.906251907348633, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="57.812503814697266"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">update1</span></div></foreignObject></g></g><g transform="translate(44.40625, 173.1956548690796)" id="state-render1-2" class="node statediagram-state"><rect height="34.130435943603516" width="70.12228393554688" y="-17.065217971801758" x="-35.06114196777344" style="" class="basic label-container"></rect><g transform="translate(-27.561141967773438, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="55.122283935546875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">render1</span></div></foreignObject></g></g><g transform="translate(44.40625, 257.3260908126831)" id="state-update2-3" class="node statediagram-state"><rect height="34.130435943603516" width="72.81250381469727" y="-17.065217971801758" x="-36.40625190734863" style="" class="basic label-container"></rect><g transform="translate(-28.906251907348633, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="57.812503814697266"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">update2</span></div></foreignObject></g></g><g transform="translate(44.40625, 341.4565267562866)" id="state-render2-4" class="node statediagram-state"><rect height="34.130435943603516" width="70.12228393554688" y="-17.065217971801758" x="-35.06114196777344" style="" class="basic label-container"></rect><g transform="translate(-27.561141967773438, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="55.122283935546875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">render2</span></div></foreignObject></g></g><g transform="translate(44.40625, 425.58696269989014)" id="state-update3-5" class="node statediagram-state"><rect height="34.130435943603516" width="72.81250381469727" y="-17.065217971801758" x="-36.40625190734863" style="" class="basic label-container"></rect><g transform="translate(-28.906251907348633, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="57.812503814697266"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">update3</span></div></foreignObject></g></g><g transform="translate(44.40625, 509.71739864349365)" id="state-...-5" class="node statediagram-state"><rect height="34.130435943603516" width="28.342391967773438" y="-17.065217971801758" x="-14.171195983886719" style="" class="basic label-container"></rect><g transform="translate(-6.671195983886719, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="13.342391967773438"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">...</span></div></foreignObject></g></g></g></g></g></svg>
</div>

Now, the `render 1` and `update 2` tasks can be made concurrent:

<!-- CONCURRENT UPDATE -->
<div style="display:block; margin:auto; text-align: center">
<svg aria-labelledby="chart-title-mermaid chart-desc-mermaid" role="img" viewBox="0 0 269.66845703125 366.521728515625" style="max-width: 471.9197998046875px;" height="366.521728515625" class="statediagram" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid"><title id="chart-title-mermaid"></title><desc id="chart-desc-mermaid"></desc><style>#mermaid {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}#mermaid .error-icon{fill:#a44141;}#mermaid .error-text{fill:#ddd;stroke:#ddd;}#mermaid .edge-thickness-normal{stroke-width:2px;}#mermaid .edge-thickness-thick{stroke-width:3.5px;}#mermaid .edge-pattern-solid{stroke-dasharray:0;}#mermaid .edge-pattern-dashed{stroke-dasharray:3;}#mermaid .edge-pattern-dotted{stroke-dasharray:2;}#mermaid .marker{fill:lightgrey;stroke:lightgrey;}#mermaid .marker.cross{stroke:lightgrey;}#mermaid svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid defs #statediagram-barbEnd{fill:lightgrey;stroke:lightgrey;}#mermaid g.stateGroup text{fill:#81B1DB;stroke:none;font-size:10px;}#mermaid g.stateGroup text{fill:#ccc;stroke:none;font-size:10px;}#mermaid g.stateGroup .state-title{font-weight:bolder;fill:#e0dfdf;}#mermaid g.stateGroup rect{fill:#1f2020;stroke:#81B1DB;}#mermaid g.stateGroup line{stroke:lightgrey;stroke-width:1;}#mermaid .transition{stroke:lightgrey;stroke-width:1;fill:none;}#mermaid .stateGroup .composit{fill:#333;border-bottom:1px;}#mermaid .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px;}#mermaid .state-note{stroke:hsl(180, 0%, 18.3529411765%);fill:hsl(180, 1.5873015873%, 28.3529411765%);}#mermaid .state-note text{fill:rgb(183.8476190475, 181.5523809523, 181.5523809523);stroke:none;font-size:10px;}#mermaid .stateLabel .box{stroke:none;stroke-width:0;fill:#1f2020;opacity:0.5;}#mermaid .edgeLabel .label rect{fill:#1f2020;opacity:0.5;}#mermaid .edgeLabel .label text{fill:#ccc;}#mermaid .label div .edgeLabel{color:#ccc;}#mermaid .stateLabel text{fill:#e0dfdf;font-size:10px;font-weight:bold;}#mermaid .node circle.state-start{fill:#f4f4f4;stroke:#f4f4f4;}#mermaid .node .fork-join{fill:#f4f4f4;stroke:#f4f4f4;}#mermaid .node circle.state-end{fill:#cccccc;stroke:#333;stroke-width:1.5;}#mermaid .end-state-inner{fill:#333;stroke-width:1.5;}#mermaid .node rect{fill:#1f2020;stroke:#81B1DB;stroke-width:1px;}#mermaid .node polygon{fill:#1f2020;stroke:#81B1DB;stroke-width:1px;}#mermaid #statediagram-barbEnd{fill:lightgrey;}#mermaid .statediagram-cluster rect{fill:#1f2020;stroke:#81B1DB;stroke-width:1px;}#mermaid .cluster-label,#mermaid .nodeLabel{color:#e0dfdf;}#mermaid .statediagram-cluster rect.outer{rx:5px;ry:5px;}#mermaid .statediagram-state .divider{stroke:#81B1DB;}#mermaid .statediagram-state .title-state{rx:5px;ry:5px;}#mermaid .statediagram-cluster.statediagram-cluster .inner{fill:#333;}#mermaid .statediagram-cluster.statediagram-cluster-alt .inner{fill:#555;}#mermaid .statediagram-cluster .inner{rx:0;ry:0;}#mermaid .statediagram-state rect.basic{rx:5px;ry:5px;}#mermaid .statediagram-state rect.divider{stroke-dasharray:10,10;fill:#555;}#mermaid .note-edge{stroke-dasharray:5;}#mermaid .statediagram-note rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:hsl(180, 0%, 18.3529411765%);stroke-width:1px;rx:0;ry:0;}#mermaid .statediagram-note rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:hsl(180, 0%, 18.3529411765%);stroke-width:1px;rx:0;ry:0;}#mermaid .statediagram-note text{fill:rgb(183.8476190475, 181.5523809523, 181.5523809523);}#mermaid .statediagram-note .nodeLabel{color:rgb(183.8476190475, 181.5523809523, 181.5523809523);}#mermaid .statediagram .edgeLabel{color:red;}#mermaid #dependencyStart,#mermaid #dependencyEnd{fill:lightgrey;stroke:lightgrey;stroke-width:1;}#mermaid :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><defs><marker orient="auto" markerUnits="strokeWidth" markerHeight="14" markerWidth="20" refY="7" refX="19" id="statediagram-barbEnd"><path d="M 19,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge6" d="M103.79483795166016,22.000000476837158L103.79483795166016,26.166667222976685C103.79483795166016,30.33333396911621,103.79483795166016,38.666667461395264,103.79483795166016,47.000000874201454C103.79483795166016,55.33333428700765,103.79483795166016,63.66666762034098,103.79483795166016,67.83333428700765L103.79483795166016,72.00000095367432"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge7" d="M79.15610290711726,106.13043689727783L73.14027608389328,110.2971035639445C67.12444926066932,114.46377023061116,55.09279561422138,122.7971035639445,49.076968790997405,131.13043689727783C43.06114196777344,139.46377023061117,43.06114196777344,147.7971035639445,43.06114196777344,151.96377023061117L43.06114196777344,156.13043689727783"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge8" d="M128.43357299620305,106.13043689727783L134.44939981942704,110.2971035639445C140.465226642651,114.46377023061116,152.49688028909893,122.7971035639445,158.51270711232291,131.13043689727783C164.52853393554688,139.46377023061117,164.52853393554688,147.7971035639445,164.52853393554688,151.96377023061117L164.52853393554688,156.13043689727783"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge9" d="M139.88979889100398,190.26087284088135L133.87397206778,194.427539507548C127.85814524455604,198.5942061742147,115.82649159810809,206.927539507548,109.81066477488412,215.26087284088135C103.79483795166016,223.5942061742147,103.79483795166016,231.927539507548,103.79483795166016,236.0942061742147L103.79483795166016,240.26087284088135"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge10" d="M189.16726898008977,190.26087284088135L195.18309580331376,194.427539507548C201.19892262653772,198.5942061742147,213.23057627298567,206.927539507548,219.24640309620963,215.26087284088135C225.2622299194336,223.5942061742147,225.2622299194336,231.927539507548,225.2622299194336,236.0942061742147L225.2622299194336,240.26087284088135"></path><path marker-end="url(#statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge11" d="M225.2622299194336,274.39130878448486L225.2622299194336,278.55797545115155C225.2622299194336,282.7246421178182,225.2622299194336,291.05797545115155,225.2622299194336,299.39130878448486C225.2622299194336,307.7246421178182,225.2622299194336,316.05797545115155,225.2622299194336,320.2246421178182L225.2622299194336,324.39130878448486"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(103.79483795166016, 15.000000476837158)" id="state-root_start-6" class="node default"><circle height="14" width="14" r="7" class="state-start"></circle></g><g transform="translate(103.79483795166016, 89.06521892547607)" id="state-update1-8" class="node statediagram-state"><rect height="34.130435943603516" width="72.81250381469727" y="-17.065217971801758" x="-36.40625190734863" style="" class="basic label-container"></rect><g transform="translate(-28.906251907348633, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="57.812503814697266"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">update1</span></div></foreignObject></g></g><g transform="translate(43.06114196777344, 173.1956548690796)" id="state-render1-7" class="node statediagram-state"><rect height="34.130435943603516" width="70.12228393554688" y="-17.065217971801758" x="-35.06114196777344" style="" class="basic label-container"></rect><g transform="translate(-27.561141967773438, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="55.122283935546875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">render1</span></div></foreignObject></g></g><g transform="translate(164.52853393554688, 173.1956548690796)" id="state-update2-10" class="node statediagram-state"><rect height="34.130435943603516" width="72.81250381469727" y="-17.065217971801758" x="-36.40625190734863" style="" class="basic label-container"></rect><g transform="translate(-28.906251907348633, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="57.812503814697266"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">update2</span></div></foreignObject></g></g><g transform="translate(103.79483795166016, 257.3260908126831)" id="state-render2-9" class="node statediagram-state"><rect height="34.130435943603516" width="70.12228393554688" y="-17.065217971801758" x="-35.06114196777344" style="" class="basic label-container"></rect><g transform="translate(-27.561141967773438, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="55.122283935546875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">render2</span></div></foreignObject></g></g><g transform="translate(225.2622299194336, 257.3260908126831)" id="state-update3-11" class="node statediagram-state"><rect height="34.130435943603516" width="72.81250381469727" y="-17.065217971801758" x="-36.40625190734863" style="" class="basic label-container"></rect><g transform="translate(-28.906251907348633, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="57.812503814697266"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">update3</span></div></foreignObject></g></g><g transform="translate(225.2622299194336, 341.4565267562866)" id="state-...-11" class="node statediagram-state"><rect height="34.130435943603516" width="28.342391967773438" y="-17.065217971801758" x="-14.171195983886719" style="" class="basic label-container"></rect><g transform="translate(-6.671195983886719, -9.565217971801758)" style="" class="label"><foreignObject height="19.130435943603516" width="13.342391967773438"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">...</span></div></foreignObject></g></g></g></g></g></svg>
</div>

Since the model is being rendered and updated at the same time, this required the introduction of an extra 'extract' step, where a representation of the scene containing the information to render is extracted to send into the render system. Once this extraction operation is done, and since the render system reads the extracted data only, the next update cycle can start safely.

Scene graph integration
-----------------------

In the ECS model the scene graph is contained in a `GraphNode` component, which
contains the tree structure as a list of references to the `GraphNode` children
instances and the `GraphNode` parent, if any. Additionally, the root node
has a special `GraphRoot` tag component. Since the scene graph needs to be 
processed from top to bottom, we have a system which acts on `GraphRoot`s 
(we only have one), and processes the whole tree. This is the first update
operation. The rest of the update operations are implemented in other systems.

Octree integration
------------------

Large star catalogs in Gaia Sky are backed by an octree which distributes
stars spatially and hierarchically according to magnitude. This is implemented 
in very much the same way as the scene graph. We have an `Octree` component,
which contains the root of the tree. An update system runs on entities with
this component (only one usually), and updates the octree by computing the
visibility of each node and updating the objects when necessary.

Try it out
----------

The ECS work is already merged into the master branch, so if you want to try it
out you just need to check out the repository and build the project:

```bash
git clone https://codeberg.org/gaiasky/gaiasky.git
cd gaiasky
./gradlew core:run
```

The ECS will be a part of the next Gaia Sky release. On top of the refactoring,
there are also countless bug fixes and a good bunch of new features.
